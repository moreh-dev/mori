root@mi300-5:/workspace/mori# PYTHONPATH=/workspace/mori pytest tests/python/ops/
======================================================================================= test session starts ========================================================================================
platform linux -- Python 3.12.11, pytest-8.4.2, pluggy-1.6.0
rootdir: /workspace/mori
plugins: assume-2.4.3, asyncio-1.2.0, anyio-4.11.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 32 items

tests/python/ops/test_dispatch_combine.py ................................                                                                                                                   [100%]

======================================================================================= 32 passed in 13.73s ========================================================================================
root@mi300-5:/workspace/mori# PYTHONPATH=/workspace/mori python tests/python/ops/bench_dispatch_combine.py
Running benchmark with max_tokens_per_rank: 4096
------------------------------------------------------------
[Gloo] Rank 0 is connected to 7 peer ranks. Expected number of connected peer ranks is : 7
[Gloo] Rank 7 is connected to 7 peer ranks. Expected number of connected peer ranks is : 7
[Gloo] Rank 1 is connected to 7 peer ranks. Expected number of connected peer ranks is : 7
[Gloo] Rank 3 is connected to 7 peer ranks. Expected number of connected peer ranks is : 7
[Gloo] Rank 2 is connected to 7 peer ranks. Expected number of connected peer ranks is : 7
[Gloo] Rank 4 is connected to 7 peer ranks. Expected number of connected peer ranks is : 7
[Gloo] Rank 6 is connected to 7 peer ranks. Expected number of connected peer ranks is : 7
[Gloo] Rank 5 is connected to 7 peer ranks. Expected number of connected peer ranks is : 7
rank 0 RDMA devices: mlx5_0, mlx5_1, mlx5_2, mlx5_3, mlx5_4
rank 2 rankInNode 2 select device [3] mlx5_3
rank 4 rankInNode 4 select device [1] mlx5_1
rank 1 rankInNode 1 select device [2] mlx5_2
rank 6 rankInNode 6 select device [3] mlx5_3
rank 7 rankInNode 7 select device [0] mlx5_0
rank 0 rankInNode 0 select device [0] mlx5_0
rank 3 rankInNode 3 select device [4] mlx5_4
rank 5 rankInNode 5 select device [3] mlx5_3
Dispatch result:
Round 0 duration(us) [833, 835, 804, 835, 831, 837, 833, 833] bandwidth(GB/s) [216, 213, 223, 214, 215, 213, 214, 215] avg bytes(MB) 170 bw 215.375(400)
Round 1 duration(us) [614, 618, 617, 615, 616, 606, 611, 606] bandwidth(GB/s) [292, 288, 289, 290, 288, 296, 291, 299] avg bytes(MB) 170 bw 291.625(400)
Round 2 duration(us) [613, 613, 613, 611, 612, 596, 611, 615] bandwidth(GB/s) [290, 294, 292, 293, 293, 301, 292, 288] avg bytes(MB) 171 bw 292.875(400)
Round 3 duration(us) [607, 608, 608, 608, 608, 605, 606, 607] bandwidth(GB/s) [296, 294, 292, 295, 295, 294, 294, 295] avg bytes(MB) 170 bw 294.375(400)
Round 4 duration(us) [598, 600, 601, 597, 597, 597, 596, 597] bandwidth(GB/s) [297, 297, 299, 299, 299, 299, 299, 300] avg bytes(MB) 170 bw 298.625(400)
Round 5 duration(us) [598, 599, 595, 597, 599, 597, 598, 597] bandwidth(GB/s) [299, 297, 299, 298, 300, 300, 301, 297] avg bytes(MB) 170 bw 298.875(400)
Round 6 duration(us) [602, 604, 597, 601, 603, 601, 600, 600] bandwidth(GB/s) [295, 297, 299, 299, 294, 297, 297, 299] avg bytes(MB) 170 bw 297.125(400)
Round 7 duration(us) [608, 607, 609, 606, 607, 606, 606, 607] bandwidth(GB/s) [293, 294, 295, 295, 295, 293, 298, 293] avg bytes(MB) 170 bw 294.5(400)
Round 8 duration(us) [598, 599, 600, 595, 599, 597, 597, 597] bandwidth(GB/s) [297, 298, 296, 298, 298, 300, 297, 299] avg bytes(MB) 170 bw 297.875(400)
Round 9 duration(us) [610, 610, 610, 607, 609, 607, 607, 606] bandwidth(GB/s) [294, 292, 293, 293, 293, 295, 295, 294] avg bytes(MB) 170 bw 293.625(400)

Combine result:
Round 0 duration(us) [719, 723, 707, 700, 684, 688, 697, 714] bandwidth(GB/s) [250, 246, 254, 256, 261, 259, 256, 251] avg bytes(MB) 170 bw 254.125(400)
Round 1 duration(us) [708, 711, 711, 703, 691, 688, 699, 708] bandwidth(GB/s) [254, 250, 251, 253, 256, 261, 255, 256] avg bytes(MB) 170 bw 254.5(400)
Round 2 duration(us) [712, 718, 716, 710, 682, 692, 695, 713] bandwidth(GB/s) [250, 251, 250, 253, 263, 260, 256, 248] avg bytes(MB) 171 bw 253.875(400)
Round 3 duration(us) [711, 706, 712, 701, 679, 678, 691, 694] bandwidth(GB/s) [253, 253, 249, 256, 264, 262, 258, 258] avg bytes(MB) 170 bw 256.625(400)
Round 4 duration(us) [721, 726, 713, 708, 687, 676, 694, 714] bandwidth(GB/s) [246, 245, 252, 252, 260, 264, 257, 250] avg bytes(MB) 170 bw 253.25(400)
Round 5 duration(us) [706, 702, 700, 693, 677, 673, 687, 701] bandwidth(GB/s) [253, 254, 255, 256, 265, 266, 262, 253] avg bytes(MB) 170 bw 258.0(400)
Round 6 duration(us) [705, 705, 707, 699, 673, 692, 691, 703] bandwidth(GB/s) [252, 254, 253, 257, 263, 258, 258, 255] avg bytes(MB) 170 bw 256.25(400)
Round 7 duration(us) [700, 700, 710, 699, 685, 685, 696, 701] bandwidth(GB/s) [254, 255, 253, 256, 262, 260, 259, 254] avg bytes(MB) 170 bw 256.625(400)
Round 8 duration(us) [689, 696, 699, 676, 673, 670, 676, 689] bandwidth(GB/s) [258, 256, 255, 262, 265, 268, 262, 259] avg bytes(MB) 170 bw 260.625(400)
Round 9 duration(us) [709, 715, 714, 698, 686, 684, 694, 707] bandwidth(GB/s) [253, 249, 250, 255, 260, 262, 258, 252] avg bytes(MB) 170 bw 254.875(400)